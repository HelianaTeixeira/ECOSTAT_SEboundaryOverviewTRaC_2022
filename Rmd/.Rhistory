#drop var not needed
drops <- c("physChemValue","StandardValue","UnitOfMeasure","physChemStandar",
"surfaceWaterBodyIntercalibrationTypeCode","surfaceWaterBodyIntercalibrationType",
"Delete")
dat<-dat[ , !(names(dat) %in% drops)]
colnames(dat) <- gsub("[.]x","",colnames(dat)) #clean ".x" from var names
#modify var names
names(dat)[names(dat) == 'CorSumMetric'] <- 'SumMetric'
names(dat)[names(dat) == 'physChemCategoryTW'] <- 'physChemCatTW'
names(dat)[names(dat) == 'physChemCategoryCW'] <- 'physChemCatCW'
names(dat)[names(dat) == 'Type'] <- 'NatType'
#Split SalinityRange,e.g."4-10" or "15-8" put 1st in Salinity1, 2nd in Salinity2
dat <- mutate(dat,Salinity1=as.numeric(dat$SalinityRange))# new num var with NAs
dat <- mutate(dat,Salinity2=NA)#create var for 2nd range
dat$Salinity2<- as.numeric(dat$Salinity2)
#identify strings containing "-" and split string to upper and lower values
for(i in 1:length(dat$SalinityRange)){
if(grepl("-",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],1,(which(strsplit(dat$SalinityRange[i], "")[[1]]=="-"))-1))
dat$Salinity2[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="-"))+1,nchar(dat$SalinityRange[i])))}
}
#identify strings containing: "< ",">= ","> " and allocate to Salinity1 and/or Salinity2
for(i in 1:length(dat$SalinityRange)){
if(grepl("<",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="<"))+1,nchar(dat$SalinityRange[i])))}
}
#subtract -1 to <
for(i in 1:length(dat$SalinityRange)){
if(grepl("<",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(dat$Salinity1[i])-1}
}
for(i in 1:length(dat$SalinityRange)){
if(grepl(">",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]==">"))+1,nchar(dat$SalinityRange[i])))}
}
#add +1 to >
for(i in 1:length(dat$SalinityRange)){
if(grepl(">",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(dat$Salinity1[i])+1}
}
for(i in 1:length(dat$SalinityRange)){
if(grepl("=",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="="))+1,nchar(dat$SalinityRange[i])))}
}
dat$Salinity1<-as.character(dat$Salinity1) #update Salinity1
dat <- mutate(dat, Salinity1=if_else(SalinityRange =="5-[0.029*(salinity)]","30",
if_else(SalinityRange=="5 - (0.028*salinity)", "30",
Salinity1)))
dat$Salinity1<-as.numeric(dat$Salinity1)
dat$Salinity2<-as.character(dat$Salinity2) #update Salinity2
dat <- mutate(dat, Salinity2=if_else(SalinityRange =="5-[0.029*(salinity)]","5",
if_else(SalinityRange=="5 - (0.028*salinity)", "5",
Salinity2))) #update revised ValueStd
dat$Salinity2<-as.numeric(dat$Salinity2)
summary(dat$ValueStd)
dat$ValueStd<-as.character(dat$ValueStd)
dat <- mutate(dat, ValueStd = case_when(SalinityRange=="5-[0.029*(salinity)]" ~  "4.13",
case_when(SalinityRange=="5 - (0.028*salinity)" ~ "4.16",
TRUE ~ ValueStd)))
dat$ValueStd<-as.character(dat$ValueStd)
dat <- mutate(dat, ValueStd = case_when(
SalinityRange=="5-[0.029*(salinity)]" ~  "4.13",
SalinityRange=="5 - (0.028*salinity)" ~ "4.16",
TRUE ~ ValueStd))
dat$ValueStd<-as.numeric(dat$ValueStd)
summary(dat$ValueStd)
summary(dat$ValueUpStd)
dat$ValueUpStd<-as.character(dat$ValueUpStd)
dat <- mutate(dat, ValueUpStd = case_when(
SalinityRange=="5-[0.029*(salinity)]" ~ "4.86",
SalinityRange=="5 - (0.028*salinity)" ~ "4.86",
TRUE ~ ValueUpStd))
dat$ValueUpStd<-as.numeric(dat$ValueUpStd)
summary(dat$ValueUpStd)
summary(dat$ReasonRange)
summary(as.factor(dat$ReasonRange))
summary(levels(as.factor(dat$ReasonRange)))
levels(as.factor(dat$ReasonRange))
dat <- mutate(dat, ReasonRange= if_else(Country=="UK" & !is.na(ValueUpStd),
"salinity range",ReasonRange))
levels(as.factor(dat$ReasonRange))
knitr::opts_chunk$set(comment = NA)
library(here)
library(dplyr)
library(magrittr)
library(tinytex)
library(stringr)
library(convertr)
library(forcats)
V <- "Rver1"     #EDIT version  number
FName1 <- here("Data","dat2_CTW.csv") #original
dat_CTW <- read.csv(file = FName1, header = TRUE,stringsAsFactors = F)
dat_CTW <- select(dat_CTW, -c("uniqueID","TypeCode",
"physChemCategoryRW","physChemCategoryLW",
"Value","ValueUp","Factor")) #drop variables not needed
FName2 <- here("Data","CTW_ver7e_rev.csv") #revised
dat_CTWrev <- read.csv(file = FName2, header = TRUE,sep= ";", stringsAsFactors = F)
dat_CTWrev <- select(dat_CTWrev, -one_of(c("uniqueID","Record"))) #drop variables not needed
#add numbering to new entries by MS
dat_CTWrev$All.obs <- replace(dat_CTWrev$All.obs,
dat_CTWrev$All.obs =="new",
seq(from = 11228, by = 1,length.out = 578))
dat_CTWrev$All.obs <- as.integer(dat_CTWrev$All.obs)
#merge by "All.obs" keeping all var & cases in both
dat <- full_join(dat_CTW,dat_CTWrev, by="All.obs")
dat <- mutate(dat, physChemCategoryCW.x=if_else(is.na(physChemCategoryCW.y),
as.character(physChemCategoryCW.x),
as.character(physChemCategoryCW.y))) #update CW revised assignments
dat <- mutate(dat, physChemCategoryTW.x=if_else(is.na(physChemCategoryTW.y),
as.character(physChemCategoryTW.x),
as.character(physChemCategoryTW.y))) #update TW revised assignments
#harmonise names within var physChemCategoryTW & physChemCategoryCW
dat$physChemCategoryCW.x<- toupper(dat$physChemCategoryCW.x)
dat$physChemCategoryTW.x<- toupper(dat$physChemCategoryTW.x)
dat <- mutate(dat, Type.x=if_else(is.na(Type.y),
as.character(Type.x),
as.character(Type.y))) #update correct Type
dat <- mutate(dat, RBD.x=if_else(is.na(RBD.y),
as.character(RBD.x),
as.character(RBD.y))) #update correct RBD
#check Country match
check.MS <- mutate(dat, matchcountry = case_when(is.na(Country.y) ~ "NA",
Country.x==Country.y ~ "match",
Country.x!=Country.y ~ "mismatch"))
levels(as.factor(check.MS$matchcountry))
dat <- mutate(dat, Country.x=if_else(is.na(Country.y),
as.character(Country.x),
as.character(Country.y))) #update Country
dat <- mutate(dat, physChemText.x=if_else(is.na(physChemText.y),
as.character(physChemText.x),
as.character(physChemText.y))) #update correct physChemText
#harmonise names within var physChemText:
dat <- mutate(dat, physChemText.x = case_when(
physChemText.x == "nitrate as N" ~ "Nitrate as N",
physChemText.x == "NTU" ~ "Turbidity",
physChemText.x == "Biological Oxygen Demand" ~ "BOD5",
TRUE   ~ as.character(physChemText.x)
))
dat <- mutate(dat, ValueStd.x=if_else(is.na(CorValueStd),
ValueStd.x,
CorValueStd)) #update revised ValueStd
dat <- mutate(dat, ValueUpStd.x=if_else(is.na(CorValueUpStd),
ValueUpStd.x,
CorValueUpStd)) #update revised ValueUpStd
dat <- mutate(dat, UnitUsed.x=if_else(is.na(UnitUsed.y),
UnitUsed.x,
UnitUsed.y)) #update revised UnitUsed
#harmonise names within var UnitUsed:
dat <- mutate(dat, UnitUsed.x = case_when(
UnitUsed.x == "ugP/L" ~ "ÂµgP/L",
TRUE   ~ as.character(UnitUsed.x)
))
dat <- mutate(dat, ICcodeTW=if_else(is.na(ICcode),
ICcodeTW,
ICcode)) #update revised ICcodeTW
dat <- mutate(dat, ICcodeTW = replace(ICcodeTW, which(physChemCategoryTW.x=="NO"), NA))
dat <- mutate(dat, ICcodeTW=na_if(ICcodeTW,""))
dat <- mutate(dat, ICcodeCW=if_else(is.na(ICcode),
ICcodeCW,
ICcode)) #update revised ICcodeCW
dat <- mutate(dat, ICcodeCW = replace(ICcodeCW, which(physChemCategoryCW.x=="NO"), NA))
dat <- mutate(dat, ICcodeCW=na_if(ICcodeCW,""))
#Portugal update GM boundary == "No" they are all reference values (Secchi and nutrients)
dat <- mutate(dat, physChemGMBoundary = replace(physChemGMBoundary, which(Country.x=="PT"), "No"))
#France Temperature update GM boundary == "No"
dat <- mutate(dat, physChemGMBoundary = replace(physChemGMBoundary, which(Country.x=="FR" & physChemText.x=="Temperature"), "No"))
dat <- mutate(dat, Ver.x=if_else(is.na(Ver.y),
Ver.x,
Ver.y)) #update Version of revised entries
#drop var
dat <- select(dat,-one_of(c("ICcode","physChemCategoryCW.y","physChemCategoryTW.y",
"Country.y","Type.y","RBD.y","physChemText.y",
"SumMetric","ValueStd.y","ValueUpStd.y","CorValueStd",
"CorValueUpStd","UnitUsed.y","Ver.y")))
dat <- mutate(dat, Cat = if_else(physChemCategoryCW.x=="NO"
& physChemCategoryTW.x =="NO", "FW", "TRAC")) #create new Water Category var
summary(dat$Cat <-as.factor(dat$Cat)) #check categories
dat <- filter(dat, Cat == "TRAC") #drop FW cases (rivers and lakes observations)
summary(as.factor(dat$Delete)) #check TRAC entries marked as "Delete" = TRUE by MS
dat <- filter(dat, Delete != "TRUE" | is.na(Delete)) #drop TRAC entries (cases) marked as "Delete" = TRUE by MS
dat %<>% mutate_if(is.character, list(~na_if(.,""))) #fill missing values with NA's
summary(as.factor(dat$physChemText.x)) #check for NA's (not considered)
dat$physChemQE <- str_replace(dat$physChemQE,
"QE3-1-2-2",
"QE3-1-2-2 Other determinand for thermal conditions") #complete QE name
dat$physChemQE <- str_replace(dat$physChemQE,
"\\. Valores corte del Real Decreto 817/2015 de 11 de septiembre",
"") #remove text from QE name
dat %>%
filter(is.na(dat$physChemText.x)) %>%
count(Country.x, physChemQE,Ver.x) #check physChemQE of cases not considered
dat <- filter (dat, !is.na(dat$physChemText.x)) #drop 29 old cases & not comparable QE
summary(as.factor(dat$physChemText.x))
levels(as.factor(dat$physChemText.x)) #QE available for comparison
dat %>% count(physChemText.x,Ver.x) # n per QE in each version
dat %>% count(dat$physChemText.x,Country.x,Ver.x) #check for old version entries/Country
dat <- filter(dat, Ver.x != "Ver7e") #keep only revised entries
dat %>% count(dat$physChemText.x,Country.x,Ver.x) #check for revised entries/Country
#identify QE with n>4 countries (MS_nr) for comparison:
dat %>%
group_by(physChemText.x)%>%
summarise(MS_nr=n_distinct(Country.x),
Select_QE=if_else(MS_nr<4,"drop","keep"))
#drop var not needed
drops <- c("physChemValue","StandardValue","UnitOfMeasure","physChemStandar",
"surfaceWaterBodyIntercalibrationTypeCode","surfaceWaterBodyIntercalibrationType",
"Delete")
dat<-dat[ , !(names(dat) %in% drops)]
colnames(dat) <- gsub("[.]x","",colnames(dat)) #clean ".x" from var names
#modify var names
names(dat)[names(dat) == 'CorSumMetric'] <- 'SumMetric'
names(dat)[names(dat) == 'physChemCategoryTW'] <- 'physChemCatTW'
names(dat)[names(dat) == 'physChemCategoryCW'] <- 'physChemCatCW'
names(dat)[names(dat) == 'Type'] <- 'NatType'
#Split SalinityRange,e.g."4-10" or "15-8" put 1st in Salinity1, 2nd in Salinity2
dat <- mutate(dat,Salinity1=as.numeric(dat$SalinityRange))# new num var with NAs
dat <- mutate(dat,Salinity2=NA)#create var for 2nd range
dat$Salinity2<- as.numeric(dat$Salinity2)
#identify strings containing "-" and split string to upper and lower values
for(i in 1:length(dat$SalinityRange)){
if(grepl("-",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],1,(which(strsplit(dat$SalinityRange[i], "")[[1]]=="-"))-1))
dat$Salinity2[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="-"))+1,nchar(dat$SalinityRange[i])))}
}
#identify strings containing: "< ",">= ","> " and allocate to Salinity1 and/or Salinity2
for(i in 1:length(dat$SalinityRange)){
if(grepl("<",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="<"))+1,nchar(dat$SalinityRange[i])))}
}
#subtract -1 to <
for(i in 1:length(dat$SalinityRange)){
if(grepl("<",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(dat$Salinity1[i])-1}
}
for(i in 1:length(dat$SalinityRange)){
if(grepl(">",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]==">"))+1,nchar(dat$SalinityRange[i])))}
}
#add +1 to >
for(i in 1:length(dat$SalinityRange)){
if(grepl(">",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(dat$Salinity1[i])+1}
}
for(i in 1:length(dat$SalinityRange)){
if(grepl("=",dat$SalinityRange[i])){dat$Salinity1[i] <- as.numeric(substr(dat$SalinityRange[i],(which(strsplit(dat$SalinityRange[i], "")[[1]]=="="))+1,nchar(dat$SalinityRange[i])))}
}
#correct UK entries (DO) according to formulas adjusting for salinity range (assumed 5-30 psu max range):
#if SalinityRange=="5-[0.029*(salinity)]" - DO ValueUpStd=4.86 for Salinity2==5 & ValueStd=4.13 for Salinity1==30
#if SalinityRange=="5-(0.028*salinity)" - DO ValueUpStd=4.86 for Salinity2==5 & ValueStd=4.16 for Salinity1==30
dat$Salinity1<-as.character(dat$Salinity1) #update Salinity1
dat <- mutate(dat, Salinity1=if_else(SalinityRange =="5-[0.029*(salinity)]","30",
if_else(SalinityRange=="5 - (0.028*salinity)", "30",
Salinity1)))
dat$Salinity1<-as.numeric(dat$Salinity1)
dat$Salinity2<-as.character(dat$Salinity2) #update Salinity2
dat <- mutate(dat, Salinity2=if_else(SalinityRange =="5-[0.029*(salinity)]","5",
if_else(SalinityRange=="5 - (0.028*salinity)", "5",
Salinity2))) #update revised ValueStd
dat$Salinity2<-as.numeric(dat$Salinity2)
#update corresponding DO ValueStd
dat$ValueStd<-as.character(dat$ValueStd)
dat <- mutate(dat, ValueStd = case_when(
SalinityRange=="5-[0.029*(salinity)]" ~  "4.13",
SalinityRange=="5 - (0.028*salinity)" ~ "4.16",
TRUE ~ ValueStd))
dat$ValueStd<-as.numeric(dat$ValueStd)
#update also DO ValueUpStd
dat$ValueUpStd<-as.character(dat$ValueUpStd)
dat <- mutate(dat, ValueUpStd = case_when(
SalinityRange=="5-[0.029*(salinity)]" ~ "4.86",
SalinityRange=="5 - (0.028*salinity)" ~ "4.86",
TRUE ~ ValueUpStd))
dat$ValueUpStd<-as.numeric(dat$ValueUpStd)
#UK
dat <- mutate(dat, ReasonRange= if_else(Country=="UK" & !is.na(ValueUpStd),
"salinity range",ReasonRange))
dat$RangeRep<-as.character(dat$RangeRep)
dat <- mutate(dat, RangeRep= if_else(Country=="UK" & ReasonRange=="salinity range",
"TRUE",RangeRep))
dat$RangeRep<-as.logical(dat$RangeRep)
#harmonise ReasonRange levels
dat <- mutate(dat, ReasonRange = case_when(
ReasonRange == "High low: Dissolved oxygen lower and upper limit" ~ "High low",
ReasonRange == "High low: Moderate (low)-Good (high) range limits?" ~ "High low",
ReasonRange == "High low?" ~ "High low",
TRUE ~ as.character(ReasonRange))) #High low
dat <- mutate(dat, ReasonRange = case_when(
ReasonRange == "?" ~ "subType",
ReasonRange == "Other?" ~ "subType",
ReasonRange == "salinity range?" ~ "salinity range",
grepl("transparency between 0.8-6m.", ReasonRange, ignore.case = FALSE) ~ "subType",
grepl("transparency between 4-35m.", ReasonRange,
ignore.case = FALSE) ~ "subType",
TRUE ~ as.character(ReasonRange))) #subType
#check steps DELETE Later
ReasRan<-dat%>%count(physChemText,ReasonRange,Country)
ReasRan
RanRep<-dat%>%count(physChemText,ReasonRange,RangeRep,Country)
RanRep
#correct SE NatType 24 & 25 are TW not CW
dat <- mutate(dat, physChemCatCW=if_else(NatType %in% c("24","25"),"NO",physChemCatCW))
dat <- mutate(dat, physChemCatTW=if_else(NatType %in% c("24","25"),"YES",physChemCatTW))
dat <- mutate(dat, Cat=if_else(
physChemCatCW=="YES","CW","TW")) #update Category levels CW & TW
dat<- dat%>%mutate(NatType=replace(NatType, NatType=="All","ALL")) #harmonise NatType All/ALL entries
#new var for TW & CW joint IC code
dat<- dat%>%mutate(ICcode.TRAC=ifelse(!is.na(as.character(dat$ICcodeTW)),
as.character(dat$ICcodeTW),
as.character(dat$ICcodeCW)))%>%
mutate(ICcode.TRAC=replace(ICcode.TRAC, is.na(ICcode.TRAC),"inapplicable"))
#id NatType NAs and fill (GReece)
id_country<- R.utils::captureOutput(unique(as.character(dat$Country[which(is.na(dat$NatType))])))
id_country<-"Greek nat type"
dat$NatType<-as.character(dat$NatType)
dat<- dat%>%mutate(NatType=replace(NatType, is.na(NatType),id_country))
#update Marine region info
dat <- mutate(dat, MarineRegion=if_else(
Country%in%c("EE","LT","LV","PL"),"Baltic Sea",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country=="IE","Celtic Seas",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country=="PT","Bay of Biscay and Iberian coast",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country=="GR","Aegean-Levantine Sea",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country=="HR","Adriatic Sea",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country %in% c("BG","RO"),"Black Sea",MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
Country=="IT","Mediterranean Sea",MarineRegion))
#ES
dat <- mutate(dat, MarineRegion=if_else(RBD %in% c("AC-T01","AC-T02","AC-T05","AC-T06","AC-T10","AC-T11","AC-T21","AC-T22","AC-T23","AC-T24","AMP-T05","AMP-T06","AT-T14","AT-T15","AT-T16"),"Western Mediterranean Sea", MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(RBD %in% c("AC-T13","AC-T19","AC-T20","AMP-T01","AMP-T02","AMP-T03","AMP-T04","AT-T12","AT-T13"),
"Bay of Biscay and Iberian coast",MarineRegion))
#UK
dat <- mutate(dat, MarineRegion=if_else(
RBD %in% c("UK01","UK03","UK04","UK05","UK06","UK07","UK08"),
"Greater North Sea", MarineRegion))
dat <- mutate(dat, MarineRegion=if_else(
RBD %in% c("UK02","UK09","UK10","UK11","UK12","UKGBNIIENW","UKGBNINE","UKGBNIIENB"),
"Celtic Seas", MarineRegion))
#"BE","NL","NO"
dat <- mutate(dat, MarineRegion=if_else(
Country %in% c("BE","NL","NO"),"Greater North Sea",MarineRegion))
#DE
dat <- mutate(dat, MarineRegion=if_else(
NatType %in% c("T1","T2","T3","T4"),"Greater North Sea",MarineRegion))
#FR
dat <- mutate(dat, MarineRegion=if_else(NatType %in% c("FRA","FRF","FRG","FRH"),"Greater North Sea",
if_else(NatType %in% c("FRD","FRE"),"Western Mediterranean Sea",
MarineRegion)))
#SE
dat <- mutate(dat, MarineRegion=if_else(NatType %in% c("10","11","12n","12s","13","15","24"),"Baltic Sea",
if_else(NatType=="25","Greater North Sea",
MarineRegion)))
dat <- mutate(dat, MarineRegion=if_else(ICcode.TRAC%in%c("CW-NEA8a","CW-NEA8b","CW-NEA9","CW-NEA10"),
"Greater North Sea", MarineRegion))
dat <- mutate(dat, MarineRegion = case_when(
grepl("CW-BC", ICcode.TRAC, ignore.case = FALSE) ~ "Baltic Sea",
TRUE ~ as.character(MarineRegion)))
dat <- mutate(dat, Note3_stdUnits = case_when(
All.obs==11359 ~ "We standardised your Value using a factor of 0.6 to convert from units of   FNU (conversion from FNU (Formazine Nephelometric Unit) to NTU: if FNU <= 20 conversion factor is 1 if FNU >20 is 0.6 NTU",
TRUE ~ Note3_stdUnits))
dat <-mutate(dat,GIG=if_else(MarineRegion%in%c("Adriatic Sea","Aegean-Levantine Sea","Mediterranean Sea","Western Mediterranean Sea"),"MED",
if_else(MarineRegion=="Baltic Sea","BAL",
if_else(MarineRegion%in%c("Bay of Biscay and Iberian coast","Greater North Sea","Celtic Seas"),"NEA","BLA"))))
# converts all vars
dat <- type.convert(dat)
dat <- mutate_at(dat,c("Note1_PhysChemText","Note2_Season",
"Note3_stdUnits","Comment","cfMS"),
as.character) #return some vars to chr
dat$Salinity2<-as.numeric(dat$Salinity2) #var to num
#reorder var in df
col_order=c("All.obs","GIG","MarineRegion","Cat","physChemCatCW","physChemCatTW","ICcode.TRAC",
"ICcodeTW","ICtypeTW","ICcodeCW","ICtypeCW","Country","RBD","NatType",
"physChemQECode","physChemQE","physChemText", "Note1_PhysChemText",
"physChemGMBoundary","SumMetric","Note2_Season","ValueStd","ValueUpStd",
"UnitUsed","Note3_stdUnits","RangeRep","ReasonRange","SalinityRange","Salinity1","Salinity2","DepthZone","Comment","cfMS","Ver")
dat <- dat[, col_order]
#save new revised TRAC dat file
dat.TRACver1r <- dat
dat.TRACver1r$Ver.r <- V # add version flag
write.csv(dat.TRACver1r, here("Data","dat.TRACver1r.csv"))
knitr::opts_chunk$set(echo = FALSE, comment = NA)
library(here)
library(tidyverse)
library(magrittr)
library(knitr)
FName1 <- here("Data","dat.TRACver1r.csv") #TRAC revised data
dat <- read.csv(file = FName1, header = TRUE)#stringsAsFactors = F
dat <- mutate_at(dat,c("Note1_PhysChemText","Note2_Season",
"Note3_stdUnits","Comment","cfMS"),
as.character) #return some fct to chr
dat_TW <- filter (dat, Cat=="TW")
dat_CW <- filter (dat, Cat=="CW")
#Table of Country records by water category: transitional (TW) and coastal (CW).
Tabl1 <-table(dat$Cat,dat$Country, useNA='ifany')
knitr::kable(Tabl1,format = "html", caption = "Table: Country records by water category: transitional (TW) and coastal (CW).")%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>% kableExtra::add_header_above(header = c(" " = 1, "Countries" = 22),align = "left")
#Table 1.1 National types correspondence to a common IC type by water category.
#summary(dat$NatType)
# dat$ICcode <- ifelse(!is.na(dat$ICcodeTW), dat$ICcodeTW, dat$ICcodeCW)
#
# Tabl1.1 <- dat%>%
#   mutate(ICcode =ifelse(!is.na(dat$ICcodeTW), dat$ICcodeTW, dat$ICcodeCW))%>%
#   mutate(ICcodeM = ifelse(is.na(ICcode), "no match",
#                              ifelse(ICcode == "inapplicable", "no match",
#                                     "match IC")))%>%
#   count(Cat,Country, ICcodeM,NatType,  useNA='ifany')%>%
#   count (Cat,Country,ICcodeM)%>%
#   spread(Cat, n)
#
# knitr::kable(Tabl1.1,format = "html",align = "lcccc" ,caption = "Table: Number of national types per country with correspondence to a common intercalibration type (IC) in each water category (TW, TW). NA:not applicable.", col.names=rep('',times=ncol(Tabl1.1)))%>%
#   kableExtra::kable_styling(full_width = TRUE, position= "center")%>% kableExtra::add_header_above(header = c("Country" = 1,"IC match" = 1, "Coastal" = 1, "Transitional" = 1 ),align = "center")
#Table 1.1 for Chapter 1
Tabl1.1b <- dat%>%
mutate(ICcode =ifelse(!is.na(dat$ICcodeTW), dat$ICcodeTW, dat$ICcodeCW))%>%
mutate(ICcodeM = ifelse(is.na(ICcode), "no match",
ifelse(ICcode == "inapplicable", "no match",
"match IC")))%>%
count(Cat,Country, ICcodeM,NatType,  useNA='ifany')%>%
count (Cat,Country,ICcodeM)
#Tabl1.1b
newTabl1.1b<-reshape::cast(Tabl1.1b, Country~Cat+ICcodeM)
#newTabl1.1b
options(knitr.kable.NA = '')
Ch1Tabl1.1<-knitr::kable(newTabl1.1b,format = "html",align = "ccccc" ,caption = "Table 1.1. Number of national types per country with correspondence to a common intercalibration type (IC) in each water category. NA:not applicable or no info.",col.names = c("Country","Match IC","No match","Match IC","No match"))%>%
kableExtra::kable_styling(full_width = TRUE, position= "center")%>%
kableExtra::add_header_above(header = c(" " = 1, "Coastal waters" = 2, "Transitional waters" = 2 ),align = "center")
Ch1Tabl1.1
readr::write_file(Ch1Tabl1.1, here("Tables","Ch1Tabl1.1.html"))
#Table of quality elements (physChemText) by category
Tabl2<-table(dat$physChemText,dat$Cat)
knitr::kable(Tabl2,format = "html", caption = "Table: Physico-Chemical Quality Elements by water category.")%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>% kableExtra::add_header_above(header = c("Quality Element" = 1, "Water category" = 2),align = "left")
#Table 3a. Physico-Chemical Quality Elements reported by n>4 countries (MS_nr) in TW.
Tabl3a <-dat_TW %>%
group_by(physChemText)%>%
summarise(MS_nr=n_distinct(Country),
Select_QE=if_else(MS_nr<4,"drop","keep"))
knitr::kable(Tabl3a,format = "html",align = "llll" ,caption = "Table: Physico-Chemical Quality Elements reported by countries in transitional waters, selecting QE reported by more than four countries.", col.names=rep('',times=ncol(Tabl3a)))%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>% kableExtra::add_header_above(header = c("Physico-Chemical QE" = 1, "No. countries" = 1, "Select QE" = 1 ),align = "left")
#Table 3b. Physico-Chemical Quality Elements reported by n>4 countries (MS_nr) in CW.
Tabl3b <-dat_CW %>%
group_by(physChemText)%>%
summarise(MS_nr=n_distinct(Country),
Select_QE=if_else(MS_nr<4,"drop","keep"))
knitr::kable(Tabl3b,format = "html",align = "llll" ,caption = "Table: Physico-Chemical Quality Elements reported by countries in coastal waters, selecting QE reported by more than four countries.", col.names=rep('',times=ncol(Tabl3b)))%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>% kableExtra::add_header_above(header = c("Physico-Chemical QE" = 1, "No. countries" = 1, "Select QE" = 1 ),align = "left")
#Table 4. Countries reporting GM boundaries vs. other criteria (e.g. reference values).
Tabl4<-table(dat$physChemGMBoundary,dat$Country, useNA = "ifany")
options(knitr.kable.NA = 'NA')
knitr::kable(Tabl4,format = "html", caption = "Table: Countries reporting GM boundaries vs. other criteria (e.g. reference values). NA: no info")%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>% kableExtra::add_header_above(header = c("GM" = 1, "Countries" = 22),align = "left")
#Table of Transitonal quality elements (physChemText) by country
Tabl5<-table(dat_TW$physChemText,dat_TW$Country)
knitr::kable(Tabl5,format = "html", caption = "Table: Physico-Chemical Quality Elements reported by country in transitional waters.")%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>%
kableExtra::add_header_above(header = c("Quality Element" = 1, "Countries" = 22),align = "left")
#Table of Coastal quality elements (physChemText) by country
Tabl6<-table(dat_CW$physChemText,dat_CW$Country)
knitr::kable(Tabl6, format = "html", caption = "Table: Physico-Chemical Quality Elements reported by country in coastal waters.")%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>%
kableExtra::add_header_above(header = c("Quality Element" = 1, "Countries" = 22),align = "left")
#Table of NAT Type ALL data
dat_ALL <- filter (dat, NatType=="ALL")
tabl.ALL <-dat_ALL %>%
count(physChemText,ICcode.TRAC,Country)
#tabl.ALL
newtabl.ALL<-reshape::cast(tabl.ALL, physChemText~Country)
#newtabl.ALL
knitr::kable(tabl.ALL, format = "html", caption = "Table: Standards applying to ALL national types per country.",col.names=rep('',times=ncol(tabl.ALL)))%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>%
kableExtra::add_header_above(header = c("Quality Element" = 1, "IC Type" = 1,"Country" = 1,"obs by Country" = 1),align = "left")
tabl.ALLrbd <-dat_ALL %>%
count(physChemText,Country,RBD)
#tabl.ALLrbd
knitr::kable(tabl.ALLrbd, format = "html", caption = "Table: Standards applying to ALL national types per country and RBD.",col.names=rep('',times=ncol(tabl.ALLrbd)))%>%
kableExtra::kable_styling(full_width = FALSE, position= "left")%>%
kableExtra::add_header_above(header = c("Quality Element" = 1, "Country" = 1,"RBD" = 1,"obs by RBD" = 1),align = "left")
newtabl.ALLrbd<-reshape::cast(tabl.ALLrbd, physChemText~Country)
#newtabl.ALLrbd
#Table 2.2 for Chapter 2
#group levels(dat$SumMetric) into metric tendency (new Var)
dat%>%
count(physChemText, SumMetric, Country)%>%
count(physChemText, SumMetric)
dat$SumMetric<-as.character(dat$SumMetric)
dat<-dat%>%
mutate(SumMetric=replace(SumMetric, SumMetric=="Minimum","minimum"))%>%
mutate(MetricType = ifelse(grepl(c("AA-EQS|AGM_int_c|Median"), SumMetric), "annual",
ifelse(grepl(c("spring|growth season mean|summer|autumn|winter"),SumMetric), "seasonal",
ifelse(grepl(c("summer minimum|minimum|5th percentile|10th percentile|90th percentile|95th percentile|98th percentile|99th percentile|MAC-EQS|maximum"),SumMetric), "quantile","other"))))
dat$SumMetric<-as.factor(dat$SumMetric)
dat$MetricType<-as.factor(dat$MetricType)
dat$MetricType <- factor(dat$MetricType, levels = c("annual","seasonal","quantile","other"))
Tabl2.2 <- dat%>%
count(Cat,physChemText, MetricType, Country)%>%
count(Cat,physChemText, MetricType)
#Tabl2.2
newTabl2.2<-reshape::cast(Tabl2.2, physChemText~Cat+MetricType)
# newTabl2.2
options(knitr.kable.NA = '')
Ch2Tabl2.2<-knitr::kable(newTabl2.2,format = "html",align = "lcccccccc" ,caption = "Table 2.2. Overview of parameters and metrics. The number of  countries using in each water category.",col.names = c("PhysChem QE","annual","seasonal","quantile","other","annual","seasonal","quantile","other"))%>%
kableExtra::kable_styling(full_width = TRUE, position= "center")%>%
kableExtra::add_header_above(header = c(" " = 1,"Central tendency" = 2," " = 2,"Central tendency" = 2," " = 2),align = "center")%>%
kableExtra::add_header_above(header = c(" " = 1, "Coastal waters" = 4, "Transitional waters" = 4 ),align = "center")
Ch2Tabl2.2
readr::write_file(Ch2Tabl2.2, here("Tables","Ch2Tabl2.2.html"))
ICType.descr = read.csv(here("Data","ICType.csv"),sep=";")
dat<- merge(dat,ICType.descr,by="ICcode.TRAC")
V <- "Rver2"     #EDIT version  number
#version 2:
#adds new vars ICType and MetricType (levels: "annual"   "seasonal" "quantile" "other")
#drops comments var
datTRACver2<-select(dat,-one_of(c("Comment","cfMS")))
datTRACver2$Ver.r <- V # add version flag
write.csv(datTRACver2, here("Data","dat.TRACver2.csv"))
#save seoarate CW & TW files
dat_TW <- filter (datTRACver2, Cat=="TW")
dat_CW <- filter (datTRACver2, Cat=="CW")
write.csv(dat_TW, here("Data","dat.TWver2.csv"))
write.csv(dat_CW, here("Data","dat.CWver2.csv"))
